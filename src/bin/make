<?php

declare(strict_types=1);

require_once __DIR__ . '/AutoloadShenanigans.php';

use Tbessenreither\MultiLevelCache\CachedServiceGenerator\Service\ArgParser;
use Tbessenreither\MultiLevelCache\CachedServiceGenerator\Service\MlcMakeCachedServiceService;
use Tbessenreither\MultiLevelCache\CachedServiceGenerator\Service\PrintTools;

function resolveServiceClass(string $service): ?string
{
    $service = str_replace('.', '\\', $service);
    // Try FQCN first
    if (class_exists($service)) {
        return $service;
    }
    // Try App\\Service namespace
    $fqcn = 'App\\Service\\' . $service;
    if (class_exists($fqcn)) {
        return $fqcn;
    }
    return null;
}

PrintTools::headline('Create or Update a cached service...');


PrintTools::info('Parsing command line arguments...');
$arguments = ArgParser::parse();
PrintTools::table(
    ['Argument', 'Value'],
    array_map(
        fn ($key, $value) => [$key, $value],
        array_keys($arguments),
        $arguments,
    ),
);

if(!isset($arguments['service'])) {
    PrintTools::error("No service specified. Use --service=App.Service.ExampleService to specify the service.");
    exit(1);
}

PrintTools::info("Resolving service class for '{$arguments['service']}'...");
$serviceClass = resolveServiceClass($arguments['service']);
if (!$serviceClass) {
    PrintTools::error("Service class for '{$arguments['service']}' not found.");
    exit(1);
}
PrintTools::line("Service class found: {$serviceClass}".PHP_EOL);

PrintTools::subHeadline('Generating cached service.');
$service = new MlcMakeCachedServiceService();
$targetFile = $service->generateCachedService($serviceClass);

if(!$targetFile) {
    PrintTools::error("Failed to generate cached service for '{$serviceClass}'.");
    exit(1);
}

PrintTools::success("Cached service generated successfully.".PHP_EOL);

PrintTools::table(
    ['Key', 'Value'],
    [
        ['Class', $targetFile['class']],
        ['Interface', $targetFile['interface']],
    ],
);
echo PHP_EOL.PHP_EOL;
